MediaPlayer=function(e){"use strict";var t,n,r,i,o,a=e,s=!1,l=!1,u=!0,d=function(){return void 0!==n&&void 0!==r},c=function(){if(!s)throw"MediaPlayer not initialized!";if(!this.capabilities.supportsMediaSource())return alert("Your browser does not support the MediaSource API.  Please try another browser, such as Chrome."),void 0;if(!n||!r)throw"Missing view or source.";l=!0,this.debug.log("Playback initiated!"),o=t.getObject("stream"),o.load(r)},f=function(){u&&d()&&c.call(this)};return t=new dijon.System,t.mapValue("system",t),t.mapOutlet("system"),t.injectInto(a),{debug:void 0,capabilities:void 0,videoModel:void 0,abrController:void 0,metricsModel:void 0,metricsConverter:void 0,metricsExt:void 0,startup:function(){s||(t.injectInto(this),s=!0)},getMetricsConverter:function(){return this.metricsConverter},getDebug:function(){return this.debug},getVideoModel:function(){return this.videoModel},setAutoPlay:function(e){u=e},getAutoPlay:function(){return u},getIsLive:function(){return this.videoModel.getIsLive()},setIsLive:function(e){this.videoModel.setIsLive(e)},getMetricsExt:function(){return this.metricsExt},getMetricsFor:function(e){var t=this.metricsModel.getReadOnlyMetricsFor(e);return t},getQualityFor:function(e){return this.abrController.getQualityFor(e)},setQualityFor:function(e,t){this.abrController.setPlaybackQuality(e,t)},getAutoSwitchQuality:function(){return this.abrController.getAutoSwitchBitrate()},setAutoSwitchQuality:function(e){this.abrController.setAutoSwitchBitrate(e)},attachView:function(e){if(!s)throw"MediaPlayer not initialized!";n=e,n.autoplay=!0,i=new MediaPlayer.models.VideoModel(n),this.videoModel.setElement(n),l||f.call(this)},attachSource:function(e){if(!s)throw"MediaPlayer not initialized!";r=e,l&&(o.reset(),o=null),f.call(this)},play:c}},MediaPlayer.prototype={constructor:MediaPlayer},MediaPlayer.dependencies={},MediaPlayer.utils={},MediaPlayer.models={},MediaPlayer.vo={},MediaPlayer.vo.metrics={},MediaPlayer.rules={},MediaPlayer.di={},MediaPlayer.di.Context=function(){"use strict";return{system:void 0,setup:function(){this.system.autoMapOutlets=!0,this.system.mapSingleton("debug",MediaPlayer.utils.Debug),this.system.mapSingleton("capabilities",MediaPlayer.utils.Capabilities),this.system.mapSingleton("videoModel",MediaPlayer.models.VideoModel),this.system.mapSingleton("manifestModel",MediaPlayer.models.ManifestModel),this.system.mapSingleton("metricsModel",MediaPlayer.models.MetricsModel),this.system.mapSingleton("mediaSourceExt",MediaPlayer.dependencies.MediaSourceExtensions),this.system.mapSingleton("sourceBufferExt",MediaPlayer.dependencies.SourceBufferExtensions),this.system.mapSingleton("bufferExt",MediaPlayer.dependencies.BufferExtensions),this.system.mapSingleton("abrController",MediaPlayer.dependencies.AbrController),this.system.mapSingleton("errHandler",MediaPlayer.dependencies.ErrorHandler),this.system.mapClass("metrics",MediaPlayer.models.MetricsList),this.system.mapClass("downloadRatioRule",MediaPlayer.rules.DownloadRatioRule),this.system.mapClass("insufficientBufferRule",MediaPlayer.rules.InsufficientBufferRule),this.system.mapClass("limitSwitchesRule",MediaPlayer.rules.LimitSwitchesRule),this.system.mapClass("abrRulesCollection",MediaPlayer.rules.BaseRulesCollection),this.system.mapClass("bufferController",MediaPlayer.dependencies.BufferController),this.system.mapClass("manifestLoader",MediaPlayer.dependencies.ManifestLoader),this.system.mapClass("manifestUpdater",MediaPlayer.dependencies.ManifestUpdater),this.system.mapClass("fragmentController",MediaPlayer.dependencies.FragmentController),this.system.mapClass("fragmentLoader",MediaPlayer.dependencies.FragmentLoader),this.system.mapClass("stream",MediaPlayer.dependencies.Stream),this.system.mapHandler("manifestUpdated","stream","manifestHasUpdated")}}},Dash=function(){"use strict";return{modules:{},dependencies:{},vo:{},di:{}}}(),Dash.di.DashContext=function(){"use strict";return{system:void 0,setup:function(){Dash.di.DashContext.prototype.setup.call(this),this.system.mapClass("parser",Dash.dependencies.DashParser),this.system.mapClass("indexHandler",Dash.dependencies.DashHandler),this.system.mapClass("baseURLExt",Dash.dependencies.BaseURLExtensions),this.system.mapClass("sonyExt",Dash.dependencies.SonyExtensions),this.system.mapClass("fragmentExt",Dash.dependencies.FragmentExtensions),this.system.mapSingleton("manifestExt",Dash.dependencies.DashManifestExtensions),this.system.mapSingleton("metricsExt",Dash.dependencies.DashMetricsExtensions),this.system.mapSingleton("metricsConverter",Dash.dependencies.DashMetricsConverter)}}},Dash.di.DashContext.prototype=new MediaPlayer.di.Context,Dash.di.DashContext.prototype.constructor=Dash.di.DashContext,Dash.dependencies.BaseURLExtensions=function(){"use strict";var e=function(e,t){for(var n,r,i,o,a,s,l,u,d,c,f=new DataView(e),g={},h=0;"sidx"!==u&&f.byteLength>h;){for(d=f.getUint32(h),h+=4,u="",o=0;4>o;o+=1)c=f.getInt8(h),u+=String.fromCharCode(c),h+=1;"moof"!==u&&"traf"!==u&&"sidx"!==u?h+=d-8:"sidx"===u&&(h-=8)}if(i=f.getUint32(h,!1)+h,i>e.byteLength)throw"sidx terminates after array buffer";for(g.version=f.getUint8(h+8),h+=12,g.timescale=f.getUint32(h+4,!1),h+=8,0===g.version?(g.earliest_presentation_time=f.getUint32(h,!1),g.first_offset=f.getUint32(h+4,!1),h+=8):(g.earliest_presentation_time=utils.Math.to64BitNumber(f.getUint32(h+4,!1),f.getUint32(h,!1)),g.first_offset=(f.getUint32(h+8,!1)<<32)+f.getUint32(h+12,!1),h+=16),g.first_offset+=i+(t||0),g.reference_count=f.getUint16(h+2,!1),h+=4,g.references=[],n=g.first_offset,r=g.earliest_presentation_time,o=0;g.reference_count>o;o+=1)s=f.getUint32(h,!1),a=s>>>31,s=2147483647&s,l=f.getUint32(h+4,!1),h+=12,g.references.push({size:s,type:a,offset:n,duration:l,time:r,timescale:g.timescale}),n+=s,r+=l;if(h!==i)throw"Error: final pos "+h+" differs from SIDX end "+i;return g},t=function(t,n,r){var i,o,a,s,l,u,d,c;for(i=e.call(this,t,r),o=i.references,a=[],l=0,u=o.length;u>l;l+=1)s=new Dash.vo.Segment,s.duration=o[l].duration,s.media=n,s.startTime=o[l].time,s.timescale=o[l].timescale,d=o[l].offset,c=o[l].offset+o[l].size-1,s.mediaRange=d+"-"+c,a.push(s);return this.debug.log("Parsed SIDX box: "+a.length+" segments."),Q.when(a)},n=function(e,t){var r,i,o,a,s,l,u,d=Q.defer(),c=new DataView(e),f=0,g="",h=0,p=!1,m=this;for(m.debug.log("Searching for initialization.");"moov"!==g&&c.byteLength>f;){for(h=c.getUint32(f),f+=4,g="",a=0;4>a;a+=1)s=c.getInt8(f),g+=String.fromCharCode(s),f+=1;"moov"!==g&&(f+=h-8)}return o=c.byteLength-f,"moov"!==g?(m.debug.log("Loading more bytes to find initialization."),t.range.start=0,t.range.end=t.bytesLoaded+t.bytesToLoad,l=new XMLHttpRequest,l.onloadend=function(){p||d.reject("Error loading initialization.")},l.onload=function(){p=!0,t.bytesLoaded=t.range.end,n.call(m,l.response).then(function(e){d.resolve(e)})},l.onerror=function(){d.reject("Error loading initialization.")},l.responseType="arraybuffer",l.open("GET",t.url),l.setRequestHeader("Range","bytes="+t.range.start+"-"+t.range.end),l.send(null)):(r=f-8,i=r+h-1,u=r+"-"+i,m.debug.log("Found the initialization.  Range: "+u),d.resolve(u)),d.promise},r=function(e){var t=Q.defer(),r=new XMLHttpRequest,i=!1,o=this,a={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:r};return o.debug.log("Start searching for initialization."),a.range.start=0,a.range.end=a.bytesToLoad,r.onloadend=function(){i||t.reject("Error finding initialization.")},r.onload=function(){i=!0,a.bytesLoaded=a.range.end,n.call(o,r.response,a).then(function(e){t.resolve(e)})},r.onerror=function(){t.reject("Error finding initialization.")},r.responseType="arraybuffer",r.open("GET",a.url),r.setRequestHeader("Range","bytes="+a.range.start+"-"+a.range.end),r.send(null),o.debug.log("Perform init search: "+a.url),t.promise},i=function(e,n){var r,o,a,s,l,u,d=Q.defer(),c=new DataView(e),f=new XMLHttpRequest,g=0,h="",p=0,m=!1,y=!1,v=this;for(v.debug.log("Searching for SIDX box."),v.debug.log(n.bytesLoaded+" bytes loaded.");"sidx"!==h&&c.byteLength>g;){for(p=c.getUint32(g),g+=4,h="",a=0;4>a;a+=1)s=c.getInt8(g),h+=String.fromCharCode(s),g+=1;"sidx"!==h&&(g+=p-8)}if(r=c.byteLength-g,"sidx"!==h)throw"Could not find SIDX box!";if(p-8>r)v.debug.log("Found SIDX but we don't have all of it."),n.range.start=0,n.range.end=n.bytesLoaded+(p-r),f.onloadend=function(){m||d.reject("Error loading sidx.")},f.onload=function(){m=!0,n.bytesLoaded=n.range.end,i.call(v,f.response,n).then(function(e){d.resolve(e)})},f.onerror=function(){d.reject("Error loading sidx.")},f.responseType="arraybuffer",f.open("GET",n.url),f.setRequestHeader("Range","bytes="+n.range.start+"-"+n.range.end),f.send(null);else if(n.range.start=g-8,n.range.end=n.range.start+p,v.debug.log("Found the SIDX box.  Start: "+n.range.start+" | End: "+n.range.end),o=e.slice(n.range.start,n.range.end),l=this.parseSIDX.call(this,o,n.range.start),u=l.references,null!==u&&void 0!==u&&u.length>0&&(y=1===u[0].type),y){v.debug.log("Initiate multiple SIDX load.");var b,M,w,S,P,R,T=[];for(b=0,M=u.length;M>b;b+=1)w=u[b].offset,S=u[b].offset+u[b].size-1,P=w+"-"+S,T.push(this.loadSegments.call(v,n.url,P));Q.all(T).then(function(e){for(R=[],b=0,M=e.length;M>b;b+=1)R=R.concat(e[b]);d.resolve(R)})}else v.debug.log("Parsing segments from SIDX."),t.call(v,o,n.url,n.range.start).then(function(e){d.resolve(e)});return d.promise},o=function(e,n){var r,o=Q.defer(),a=new XMLHttpRequest,s=!1,l=this,u={url:e,range:{},searching:!1,bytesLoaded:0,bytesToLoad:1500,request:a};return null===n?(l.debug.log("No known range for SIDX request."),u.searching=!0,u.range.start=0,u.range.end=u.bytesToLoad):(r=n.split("-"),u.range.start=parseFloat(r[0]),u.range.end=parseFloat(r[1])),a.onloadend=function(){s||o.reject("Error loading sidx.")},a.onload=function(){s=!0,u.searching?(u.bytesLoaded=u.range.end,i.call(l,a.response,u).then(function(e){o.resolve(e)})):t.call(l,a.response,u.url,u.range.start).then(function(e){o.resolve(e)})},a.onerror=function(){o.reject("Error loading sidx.")},a.responseType="arraybuffer",a.open("GET",u.url),a.setRequestHeader("Range","bytes="+u.range.start+"-"+u.range.end),a.send(null),l.debug.log("Perform SIDX load: "+u.url),o.promise};return{debug:void 0,loadSegments:o,loadInitialization:r,parseSegments:t,parseSIDX:e,findSIDX:i}},Dash.dependencies.BaseURLExtensions.prototype={constructor:Dash.dependencies.BaseURLExtensions},Dash.dependencies.DashHandler=function(){"use strict";var e,t,n,r=-1,i=function(e,t){var n=null;return t&&t.Representation_asArray&&t.Representation_asArray.length>0&&(n=t.Representation_asArray[e]),n},o=function(e,t){var n=""+t;return e.split("$Number$").join(n)},a=function(e,t){var n=""+t;return e.split("$Time$").join(n)},s=function(e,t){var n=""+t;return e.split("$Bandwidth$").join(n)},l=function(e,t){if(null===t||-1===e.indexOf("$RepresentationID$"))return e;var n=""+t;return e.split("$RepresentationID$").join(n)},u=function(e,t){var n;return n=e===t?e:-1!==e.indexOf("http://")?e:t+e},d=function(e,t){var r=Q.defer(),o=i(e,t),a=null,d=null,c=null,f=null,g=this;return g.debug.log("Getting the initialization request."),o.hasOwnProperty("SegmentTemplate")?o.SegmentTemplate.hasOwnProperty("initialization")&&(d=o.SegmentTemplate.initialization,d=s(d,o.bandwidth),d=l(d,o.id)):o.hasOwnProperty("SegmentList")&&o.SegmentList.hasOwnProperty("Initialization")&&o.SegmentList.Initialization.hasOwnProperty("sourceURL")?d=o.SegmentList.Initialization.sourceURL:o.hasOwnProperty("SegmentBase")&&o.SegmentBase.hasOwnProperty("Initialization")&&o.SegmentBase.Initialization.hasOwnProperty("range")?(d=o.BaseURL,f=o.SegmentBase.Initialization.range):(c=o.BaseURL,g.baseURLExt.loadInitialization(c).then(function(e){g.debug.log("Got an initialization."),a=new MediaPlayer.vo.SegmentRequest,a.streamType=n,a.type="Initialization Segment",a.url=u(c,o.BaseURL),a.range=e,r.resolve(a)},function(){g.errHandler.downloadError("Error loading initialization.")})),d&&d.length>0&&(g.debug.log("Got an initialization."),a=new MediaPlayer.vo.SegmentRequest,a.streamType=n,a.type="Initialization Segment",a.url=u(d,o.BaseURL),a.range=f,r.resolve(a)),r.promise},c=function(n){var i,o,a,s,l=!1;return this.debug.log("Checking for stream end..."),e?(this.debug.log("Live never ends! (TODO)"),l=!1):n.hasOwnProperty("segments")&&null!==n.segments?(this.debug.log("Segments: "+r+" / "+n.segments.length),l=r>=n.segments.length):n.hasOwnProperty("SegmentTemplate")&&!n.SegmentTemplate.hasOwnProperty("SegmentTimeline")&&(o=1,s=Math.floor(t),n.SegmentTemplate.hasOwnProperty("duration")&&(i=n.SegmentTemplate.duration,n.SegmentTemplate.hasOwnProperty("timescale")&&(o=n.SegmentTemplate.timescale),a=i/o,this.debug.log("SegmentTemplate: "+a+" * "+r+" = "+a*r+" / "+s),l=a*r>=s)),Q.when(l)},f=function(e,t){var n,r,i,s,l,u,d,c,f,g=[],h=0,p=0;for(n=t.S_asArray,i=0,s=n.length;s>i;i+=1)for(r=n[i],u=0,r.hasOwnProperty("r")&&(u=r.r),l=0;u>=l;l+=1)d=new Dash.vo.Segment,d.timescale=e.timescale,r.hasOwnProperty("t")?(d.startTime=r.t,h=r.t):d.startTime=h,d.duration=r.d,f=e.hasOwnProperty("startNumber")?e.startNumber+p:p,c=e.media,c=o(c,f),c=a(c,d.startTime),d.media=c,g.push(d),h+=d.duration,p+=1;return Q.when(g)},g=function(e){var t,n,r,i,o=[];for(t=0,n=e.SegmentURL_asArray.length;n>t;t+=1)i=e.SegmentURL_asArray[t],r=new Dash.vo.Segment,r.media=i.media,r.mediaRange=i.mediaRange,r.index=i.index,r.indexRange=i.indexRange,r.timescale=e.timescale,r.duration=e.duration,r.startTime=t*e.duration,o.push(r);return Q.when(o)},h=function(e){var t=e.BaseURL,n=null;return this.manifestModel.getValue(),e.hasOwnProperty("SegmentBase")&&e.SegmentBase.hasOwnProperty("indexRange")&&(n=e.SegmentBase.indexRange),this.baseURLExt.loadSegments(t,n)},p=function(e){var t;return t=e.hasOwnProperty("SegmentTemplate")&&!e.SegmentTemplate.hasOwnProperty("SegmentTimeline")?Q.when(null):e.hasOwnProperty("segments")&&null!==e.segments?Q.when(e.segments):e.hasOwnProperty("SegmentTemplate")&&e.SegmentTemplate.hasOwnProperty("SegmentTimeline")?f.call(this,e.SegmentTemplate,e.SegmentTemplate.SegmentTimeline):e.hasOwnProperty("SegmentList")?g.call(this,e.SegmentList):h.call(this,e)},m=function(e,t){var n,r,i=-1;if(t){for(i=0,r=0,n=null;e>=r&&t.length>i+1;)n=t[i],r+=n.duration/n.timescale,i+=1;i-=1}return function(){return Q.when(i)}()},y=function(e,t){var n,r,i=-1,o=1;if(!t.hasOwnProperty("duration"))throw"Expected 'duration' attribute on SegmentTemplate!";return n=t.duration,t.hasOwnProperty("timescale")&&(o=t.timescale),r=n/o,i=Math.floor(e/r),function(){return Q.when(i)}()},v=function(e,t,r){var i,d,c,f=new MediaPlayer.vo.SegmentRequest;return d=t.hasOwnProperty("startNumber")?t.startNumber+e:e,c=t.duration*e,t.hasOwnProperty("timescale")&&(c/=t.timescale),c=Math.floor(c),i=t.media,i=o(i,d),i=a(i,c),i=s(i,r.bandwidth),i=l(i,r.id),f.streamType=n,f.type="Media Segment",f.url=u(i,r.BaseURL),f.duration=t.duration/t.timescale,f.timescale=t.timescale,f.startTime=d*t.duration/t.timescale,function(){return Q.when(f)}()},b=function(e,t,r){var i,d=new MediaPlayer.vo.SegmentRequest;return i=u(t.media,r.BaseURL),i=o(i,e),i=a(i,t.startTime),i=s(i,r.bandwidth),i=l(i,r.id),d.streamType=n,d.type="Media Segment",d.url=i,d.range=t.mediaRange,d.startTime=t.startTime/t.timescale,d.duration=t.duration/t.timescale,d.timescale=t.timescale,function(){return Q.when(d)}()},M=function(e,t,n){var o,a,s,l=i(t,n),u=!1,d=this;return d.debug.log("Getting the request for time: "+e),o=Q.defer(),p.call(d,l).then(function(t){var n;if(d.debug.log("Got segments."),d.debug.log(t),null===t){if(!l.hasOwnProperty("SegmentTemplate"))throw"Expected SegmentTemplate!";u=!0,d.debug.log("No segments found, so we must be using a SegmentTemplate."),n=y.call(d,e,l.SegmentTemplate)}else d.debug.log("Got a list of segments, so dig deeper."),l.segments=t,u=!1,n=m.call(d,e,t);return n}).then(function(t){return d.debug.log("Index for time "+e+" is "+t),r=t,c.call(d,l)}).then(function(e){var t=null;return d.debug.log("Stream finished? "+e),e?(a=new MediaPlayer.vo.SegmentRequest,a.action=a.ACTION_COMPLETE,d.debug.log("Signal complete."),d.debug.log(a),o.resolve(a)):u?t=v.call(d,r,l.SegmentTemplate,l):(s=l.segments[r],t=b.call(d,r,s,l)),t}).then(function(e){d.debug.log("Got a request."),d.debug.log(e),o.resolve(e)}),o.promise},w=function(e,t){var n,o,a,s=i(e,t),l=this;if(l.debug.log("Getting the next request."),-1===r)throw"You must call getSegmentRequestForTime first.";return r+=1,l.debug.log("New index: "+r),n=Q.defer(),c.call(l,s).then(function(e){l.debug.log("Stream finished? "+e),e?(o=new MediaPlayer.vo.SegmentRequest,o.action=o.ACTION_COMPLETE,l.debug.log("Signal complete."),l.debug.log(o),n.resolve(o)):p.call(l,s).then(function(e){var t;if(l.debug.log("Got segments."),l.debug.log(e),null===e){if(!s.hasOwnProperty("SegmentTemplate"))throw"Expected SegmentTemplate!";l.debug.log("No segments found, so we must be using a SegmentTemplate."),t=v.call(l,r,s.SegmentTemplate,s)}else s.segments=e,a=s.segments[r],t=b.call(l,r,a,s);return t}).then(function(e){l.debug.log("Got a request."),l.debug.log(e),n.resolve(e)})}),n.promise};return{debug:void 0,baseURLExt:void 0,sonyExt:void 0,manifestModel:void 0,errHandler:void 0,getType:function(){return n},setType:function(e){n=e},getIsLive:function(){return e},setIsLive:function(t){e=t},getDuration:function(){return t},setDuration:function(e){t=e},getInitRequest:d,getSegmentRequestForTime:M,getNextSegmentRequest:w}},Dash.dependencies.DashHandler.prototype={constructor:Dash.dependencies.DashHandler},Dash.dependencies.DashManifestExtensions=function(){"use strict"},Dash.dependencies.DashManifestExtensions.prototype={constructor:Dash.dependencies.DashManifestExtensions,getIsAudio:function(e){"use strict";var t,n,r,i=e.ContentComponent_asArray,o=!1,a=!1;if(i)for(t=0,n=i.length;n>t;t+=1)"audio"===i[t].contentType&&(o=!0,a=!0);if(e.hasOwnProperty("mimeType")&&(o=-1!==e.mimeType.indexOf("audio"),a=!0),!a)for(t=0,n=e.Representation_asArray.length;!a&&n>t;)r=e.Representation_asArray[t],r.hasOwnProperty("mimeType")&&(o=-1!==r.mimeType.indexOf("audio"),a=!0),t+=1;return Q.when(o)},getIsVideo:function(e){"use strict";var t,n,r,i=e.ContentComponent_asArray,o=!1,a=!1;if(i)for(t=0,n=i.length;n>t;t+=1)"video"===i[t].contentType&&(o=!0,a=!0);if(e.hasOwnProperty("mimeType")&&(o=-1!==e.mimeType.indexOf("video"),a=!0),!a)for(t=0,n=e.Representation_asArray.length;!a&&n>t;)r=e.Representation_asArray[t],r.hasOwnProperty("mimeType")&&(o=-1!==r.mimeType.indexOf("video"),a=!0),t+=1;return Q.when(o)},getIsMain:function(){"use strict";return Q.when(!1)},processAdaptation:function(e){"use strict";return void 0!==e.Representation_asArray&&null!==e.Representation_asArray&&e.Representation_asArray.sort(function(e,t){return e.bandwidth-t.bandwidth}),e},getDataForId:function(e,t){"use strict";var n,r,i=t.Period_asArray[0].AdaptationSet_asArray;for(n=0,r=i.length;r>n;n+=1)if(i[n].hasOwnProperty("id")&&i[n].id===e)return Q.when(i[n]);return Q.when(null)},getDataForIndex:function(e,t){"use strict";var n=t.Period_asArray[0].AdaptationSet_asArray;return Q.when(n[e])},getDataIndex:function(e,t){"use strict";var n,r,i=t.Period_asArray[0].AdaptationSet_asArray;for(n=0,r=i.length;r>n;n+=1)if(i[n]===e)return Q.when(n);return Q.when(-1)},getVideoData:function(e){"use strict";var t,n,r=this,i=e.Period_asArray[0].AdaptationSet_asArray,o=Q.defer(),a=[];for(t=0,n=i.length;n>t;t+=1)a.push(this.getIsVideo(i[t]));return Q.all(a).then(function(e){var a=!1;for(t=0,n=e.length;n>t;t+=1)e[t]===!0&&(a=!0,o.resolve(r.processAdaptation(i[t])));a||o.resolve(null)}),o.promise},getAudioDatas:function(e){"use strict";var t,n,r=this,i=e.Period_asArray[0].AdaptationSet_asArray,o=Q.defer(),a=[];for(t=0,n=i.length;n>t;t+=1)a.push(this.getIsAudio(i[t]));return Q.all(a).then(function(e){var a=[];for(t=0,n=e.length;n>t;t+=1)e[t]===!0&&a.push(r.processAdaptation(i[t]));o.resolve(a)}),o.promise},getPrimaryAudioData:function(e){"use strict";var t,n,r=Q.defer(),i=[],o=this;return this.getAudioDatas(e).then(function(e){for(e&&0!==e.length||r.resolve(null),t=0,n=e.length;n>t;t+=1)i.push(o.getIsMain(e[t]));Q.all(i).then(function(i){var a=!1;for(t=0,n=i.length;n>t;t+=1)i[t]===!0&&(a=!0,r.resolve(o.processAdaptation(e[t])));a||r.resolve(e[0])})}),r.promise},getCodec:function(e){"use strict";var t=e.Representation_asArray[0],n=t.mimeType+';codecs="'+t.codecs+'"';return Q.when(n)},getLiveOffset:function(e){"use strict";var t=5;return e.hasOwnProperty("suggestedPresentationDelay")&&(t=e.suggestedPresentationDelay),Q.when(t)},getLiveEdge:function(e){"use strict";var t,n=this,r=Q.defer(),i=0,o=new Date,a=e.availabilityStartTime;return n.getLiveOffset(e).then(function(n){e.hasOwnProperty("availabilityEndTime")?(t=e.availabilityEndTime,i=(t.getTime()-a.getTime())/1e3):i=(o.getTime()-a.getTime())/1e3,i-=n,0>i&&(i=0),i=Math.floor(i),r.resolve(i)}),r.promise},getIsDVR:function(e,t){"use strict";var n,r;return n=!isNaN(e.timeShiftBufferDepth),r=t&&n,Q.when(r)},getIsOnDemand:function(e){"use strict";var t=!1;return e.profiles&&e.profiles.length>0&&(t=-1!==e.profiles.indexOf("urn:mpeg:dash:profile:isoff-on-demand:201")),Q.when(t)},getDuration:function(e,t){"use strict";var n=0/0;return t?n=Number.POSITIVE_INFINITY:e.mediaPresentationDuration?n=e.mediaPresentationDuration:e.availabilityEndTime&&e.availabilityStartTime&&(n=e.availabilityEndTime.getTime()-e.availabilityStartTime.getTime()),Q.when(n)},getBandwidth:function(e){"use strict";return Q.when(e.bandwidth)},getRefreshDelay:function(e){"use strict";var t=0/0;return e.hasOwnProperty("minimumUpdatePeriod")&&(t=parseFloat(e.minimumUpdatePeriod)),Q.when(t)},getRepresentationCount:function(e){"use strict";return Q.when(e.Representation_asArray.length)},getRepresentationFor:function(e,t){"use strict";return Q.when(t.Representation_asArray[e])}},Dash.dependencies.DashMetricsConverter=function(){"use strict";var e=function(e){var t,n,r,i,o,a=[];for(o=0;e.length>o;o+=1)n=e[o],t={},t.text="Buffer: "+(o+1),t.items=[],r={},r.text="t: "+n.t,i={},i.text="level: "+n.level,t.items.push(r),t.items.push(i),a.push(t);return a},t=function(e){var t,n,r,i,o,a,s,l,u,d=[];for(u=0;e.length>u;u+=1)n=e[u],t={},t.text="Trace: "+(u+1),t.items=[],r={},r.text="representationid: "+n.representationid,i={},i.text="subreplevel: "+n.subreplevel,o={},o.text="start: "+n.start,a={},a.text="duration: "+n.duration,s={},s.text="playbackspeed: "+n.playbackspeed,l={},l.text="stopreason: "+n.stopreason,t.items.push(r),t.items.push(i),t.items.push(o),t.items.push(a),t.items.push(s),t.items.push(l),d.push(t);return d},n=function(e){var n,r,i,o,a,s,l,u=[];for(l=0;e.length>l;l+=1)r=e[l],n={},n.text="PlayList: "+(l+1),n.items=[],i={},i.text="start: "+r.start,o={},o.text="mstart: "+r.mstart,a={},a.text="starttype: "+r.starttype,s={},s.text="trace",s.items=t(r.trace),n.items.push(i),n.items.push(o),n.items.push(a),n.items.push(s),u.push(n);return u},r=function(e){var t,n,r,i,o,a,s,l=[];for(s=0;e.length>s;s+=1)n=e[s],t={},t.text="Representation Switch: "+(s+1),t.items=[],r={},r.text="t: "+n.t,i={},i.text="mt: "+n.mt,o={},o.text="to: "+n.to,a={},a.text="lto: "+n.lto,t.items.push(r),t.items.push(i),t.items.push(o),t.items.push(a),l.push(t);return l},i=function(e){var t,n,r,i,o,a=[];for(o=0;e.length>o;o+=1)n=e[o],t={},t.text="DroppedFrame: "+(o+1),t.items=[],r={},r.text="time: "+n.time,i={},i.text="droppedFrames: "+n.droppedFrames,t.items.push(r),t.items.push(i),a.push(t);return a},o=function(e){var t,n,r,i,o,a,s=[];for(a=0;e.length>a;a+=1)n=e[a],t={},t.text="Trace: "+(a+1),t.items=[],r={},r.text="s: "+n.s,i={},i.text="d: "+n.d,o={},o.text="b: "+(""+n.b),t.items.push(r),t.items.push(i),t.items.push(o),s.push(t)},a=function(e){var t,n,r,i,a,s,l,u,d,c,f,g,h,p,m=[];for(p=0;e.length>p;p+=1)n=e[p],t={},t.text="Http Request: "+(p+1),t.items=[],r={},r.text="tcpid: "+n.tcpid,i={},i.text="type: "+n.type,a={},a.text="url: "+n.url,s={},s.text="actualurl: "+n.actualurl,l={},l.text="range: "+n.range,u={},u.text="trequest: "+n.trequest,d={},d.text="tresponse: "+n.tresponse,c={},c.text="responsecode: "+n.responsecode,f={},f.text="interval: "+n.interval,g={},g.text="mediaduration: "+n.mediaduration,h={},h.text="trace",h.items=o(n.trace),t.items.push(r),t.items.push(i),t.items.push(a),t.items.push(s),t.items.push(l),t.items.push(u),t.items.push(d),t.items.push(c),t.items.push(f),t.items.push(g),t.items.push(h),m.push(t);return m},s=function(e){var t,n,r,i,o,a,s,l,u=[];for(l=0;e.length>l;l+=1)n=e[l],t={},t.text="TCP Connection: "+(l+1),t.items=[],r={},r.text="tcpid: "+n.tcpid,i={},i.text="dest: "+n.dest,o={},o.text="topen: "+n.topen,a={},a.text="tclose: "+n.tclose,s={},s.text="tconnect: "+n.tconnect,t.items.push(r),t.items.push(i),t.items.push(o),t.items.push(a),t.items.push(s),u.push(t);return u},l=function(t){var o,l=e(t.BufferLevel),u=n(t.PlayList),d=r(t.RepSwitchList),c=i(t.DroppedFrames),f=a(t.HttpList),g=s(t.TcpList);return o=new kendo.data.HierarchicalDataSource({data:[{text:"Buffer Level",items:l},{text:"Representation Switch",items:d},{text:"Dropped Frames",items:c},{text:"Play List",items:u},{text:"HTTP Request",items:f},{text:"TCP Connection",items:g}]})};return{toTreeViewDataSource:l}},Dash.dependencies.DashMetricsConverter.prototype={constructor:Dash.dependencies.DashMetricsConverter},Dash.dependencies.DashMetricsExtensions=function(){"use strict";var e=function(e,t){var n,r,i,o,a,s,l,u;for(s=0;e.length>s;s+=1)for(n=e[s],i=n.AdaptationSet_asArray,l=0;i.length>l;l+=1)for(r=i[l],a=r.Representation_asArray,u=0;a.length>u;u+=1)if(o=a[u],t===o.id)return u;return-1},t=function(e,t){var n,r,i,o,a,s,l,u;for(s=0;e.length>s;s+=1)for(n=e[s],i=n.AdaptationSet_asArray,l=0;i.length>l;l+=1)for(r=i[l],a=r.Representation_asArray,u=0;a.length>u;u+=1)if(o=a[u],t===o.id)return o;return null},n=function(e,t){var n,r,i=!1;return e.hasOwnProperty("mimeType")?n=e.mimeType:e.hasOwnProperty("ContentComponent")&&(r=e.ContentComponent,n=r.contentType),n=n.toLowerCase(),t=t.toLowerCase(),-1!==n.indexOf(t)&&(i=!0),i},r=function(e,t){var r,i,o,a,s,l;for(s=0;e.length>s;s+=1)for(r=e[s],o=r.AdaptationSet_asArray,l=0;o.length>l;l+=1)if(i=o[l],a=i.Representation_asArray,n(i,t))return a.length;return-1},i=function(e){var n,r=this,i=r.manifestModel.getValue(),o=i.Period_asArray;return n=t.call(r,o,e),null===n?null:n.bandwidth},o=function(t){var n,r=this,i=r.manifestModel.getValue(),o=i.Period_asArray;return n=e.call(r,o,t)},a=function(e){var t,n=this,i=n.manifestModel.getValue(),o=i.Period_asArray;return t=r(o,e)},s=function(e){if(null===e)return null;var t,n,r,i=e.RepSwitchList;return null===i||0>=i.length?null:(t=i.length,n=t-1,r=i[n])},l=function(e){if(null===e)return null;var t,n,r,i=e.BufferLevel;return null===i||0>=i.length?null:(t=i.length,n=t-1,r=i[n])},u=function(e){if(null===e)return null;var t,n,r,i=e.HttpList;return null===i||0>=i.length?null:(t=i.length,n=t-1,r=i[n])},d=function(e){if(null===e)return null;var t,n,r,i=e.DroppedFrames;return null===i||0>=i.length?null:(t=i.length,n=t-1,r=i[n])};return{manifestModel:void 0,getBandwidthForRepresentation:i,getIndexForRepresentation:o,getMaxIndexForBufferType:a,getCurrentRepresentationSwitch:s,getCurrentBufferLevel:l,getCurrentHttpRequest:u,getCurrentDroppedFrames:d}},Dash.dependencies.DashMetricsExtensions.prototype={constructor:Dash.dependencies.DashMetricsExtensions},Dash.dependencies.DashParser=function(){"use strict";var e=31536e3,t=2592e3,n=86400,r=3600,i=60,o=/P(([\d.]*)Y)?(([\d.]*)M)?(([\d.]*)D)?T(([\d.]*)H)?(([\d.]*)M)?(([\d.]*)S)?/,a=/^(\d{4}\-\d\d\-\d\d([tT][\d:\.]*)?)([zZ]|([+\-])(\d\d):(\d\d))?$/,s=/^[-+]?[0-9]+[.]?[0-9]*([eE][-+]?[0-9]+)?$/,l=[{type:"duration",test:function(e){return o.test(e)},converter:function(a){var s=o.exec(a);return parseFloat(s[2]||0)*e+parseFloat(s[4]||0)*t+parseFloat(s[6]||0)*n+parseFloat(s[8]||0)*r+parseFloat(s[10]||0)*i+parseFloat(s[12]||0)}},{type:"datetime",test:function(e){return a.test(e)},converter:function(e){return new Date(e)}},{type:"numeric",test:function(e){return s.test(e)},converter:function(e){return parseFloat(e)}}],u=function(){var e,t,n,r;return r=[{name:"profiles",merge:!1},{name:"width",merge:!1},{name:"height",merge:!1},{name:"sar",merge:!1},{name:"frameRate",merge:!1},{name:"audioSamplingRate",merge:!1},{name:"mimeType",merge:!1},{name:"segmentProfiles",merge:!1},{name:"codecs",merge:!1},{name:"maximumSAPPeriod",merge:!1},{name:"startsWithSap",merge:!1},{name:"maxPlayoutRate",merge:!1},{name:"codingDependency",merge:!1},{name:"scanType",merge:!1},{name:"FramePacking",merge:!0},{name:"AudioChannelConfiguration",merge:!0},{name:"ContentProtection",merge:!0}],e={},e.name="AdaptationSet",e.isRoot=!1,e.isArray=!0,e.parent=null,e.children=[],e.properties=r,t={},t.name="Representation",t.isRoot=!1,t.isArray=!0,t.parent=e,t.children=[],t.properties=r,e.children.push(t),n={},n.name="SubRepresentation",n.isRoot=!1,n.isArray=!0,n.parent=t,n.children=[],n.properties=r,t.children.push(n),e},d=function(){var e,t,n,r;return r=[{name:"SegmentBase",merge:!0},{name:"SegmentTemplate",merge:!0},{name:"SegmentList",merge:!0}],e={},e.name="Period",e.isRoot=!1,e.isArray=!0,e.parent=null,e.children=[],e.properties=r,t={},t.name="AdaptationSet",t.isRoot=!1,t.isArray=!0,t.parent=e,t.children=[],t.properties=r,e.children.push(t),n={},n.name="Representation",n.isRoot=!1,n.isArray=!0,n.parent=t,n.children=[],n.properties=r,t.children.push(n),e},c=function(){var e,t,n,r,i;return i=[{name:"BaseURL",merge:!0,mergeFunction:function(e,t){var n;return n=0===t.indexOf("http://")?t:e+t}}],e={},e.name="mpd",e.isRoot=!0,e.isArray=!0,e.parent=null,e.children=[],e.properties=i,t={},t.name="Period",t.isRoot=!1,t.isArray=!0,t.parent=null,t.children=[],t.properties=i,e.children.push(t),n={},n.name="AdaptationSet",n.isRoot=!1,n.isArray=!0,n.parent=t,n.children=[],n.properties=i,t.children.push(n),r={},r.name="Representation",r.isRoot=!1,r.isArray=!0,r.parent=n,r.children=[],r.properties=i,n.children.push(r),e},f=function(){var e=[];return e.push(u()),e.push(d()),e.push(c()),e},g=function(e,t){this.debug.log("Doing parse.");var n,r=new X2JS(l,"",!0),i=new ObjectIron(f());return this.debug.log("Converting from XML."),n=r.xml_str2json(e),n.hasOwnProperty("BaseURL")||(this.debug.log("Setting baseURL: "+t),n.BaseURL=t),0!==n.BaseURL.indexOf("http")&&(n.BaseURL=t+n.BaseURL),this.debug.log("Flatten manifest properties."),i.run(n),this.debug.log("Parsing complete."),Q.when(n)};return{debug:void 0,parse:g}},Dash.dependencies.DashParser.prototype={constructor:Dash.dependencies.DashParser},Dash.dependencies.FragmentExtensions=function(){"use strict";var e=function(e){for(var t,n,r,i,o,a,s=Q.defer(),l=new DataView(e),u=0;"tfdt"!==i&&l.byteLength>u;){for(r=l.getUint32(u),u+=4,i="",o=0;4>o;o+=1)a=l.getInt8(u),i+=String.fromCharCode(a),u+=1;"moof"!==i&&"traf"!==i&&"tfdt"!==i&&(u+=r-8)}if(u===l.byteLength)throw"Error finding live offset.";return n=l.getUint8(u),this.debug.log("position: "+u),0===n?(u+=4,t=l.getUint32(u,!1)):(u+=r-16,t=utils.Math.to64BitNumber(l.getUint32(u+4,!1),l.getUint32(u,!1))),s.resolve({version:n,base_media_decode_time:t}),s.promise},t=function(e){for(var t,n,r,i,o,a,s,l=new DataView(e),u=0;"sidx"!==o&&l.byteLength>u;){for(a=l.getUint32(u),u+=4,o="",i=0;4>i;i+=1)s=l.getInt8(u),o+=String.fromCharCode(s),u+=1;"moof"!==o&&"traf"!==o&&"sidx"!==o?u+=a-8:"sidx"===o&&(u-=8)}return t=l.getUint8(u+8),u+=12,n=l.getUint32(u+4,!1),u+=8,r=0===t?l.getUint32(u,!1):utils.Math.to64BitNumber(l.getUint32(u+4,!1),l.getUint32(u,!1)),Q.when({earliestPresentationTime:r,timescale:n})},n=function(t){var n,r,i,o=Q.defer(),a=new XMLHttpRequest,s=!1;return n=t,a.onloadend=function(){s||(r="Error loading fragment: "+n,o.reject(r))},a.onload=function(){s=!0,i=e(a.response),o.resolve(i)},a.onerror=function(){r="Error loading fragment: "+n,o.reject(r)},a.responseType="arraybuffer",a.open("GET",n),a.send(null),o.promise};return{debug:void 0,loadFragment:n,parseTFDT:e,parseSIDX:t}},Dash.dependencies.FragmentExtensions.prototype={constructor:Dash.dependencies.FragmentExtensions},Dash.dependencies.SonyExtensions=function(){"use strict";
var e,t,n=!1,r=0,i=1500,o=function(e,t){for(var n,r,i,o,a,s,l,u,d,c,f,g,h=new DataView(e),p=0,m=[];"sidx"!==c&&h.byteLength>p;){for(f=h.getUint32(p),p+=4,c="",l=0;4>l;l+=1)g=h.getInt8(p),c+=String.fromCharCode(g),p+=1;"moof"!==c&&"traf"!==c&&"sidx"!==c?p+=f-8:"sidx"===c&&(p-=8)}if(n=h.getUint32(p,!1)+p,n>e.byteLength)throw"sidx terminates after array buffer";for(r=h.getUint8(p+8),p+=12,i=h.getUint32(p+4,!1),p+=8,0===r?(o=h.getUint32(p,!1),a=h.getUint32(p+4,!1),p+=8):(o=utils.Math.to64BitNumber(h.getUint32(p+4,!1),h.getUint32(p,!1)),a=(h.getUint32(p+8,!1)<<32)+h.getUint32(p+12,!1),p+=16),a+=n+(t||0),s=h.getUint16(p+2,!1),p+=4,l=0;s>l;l+=1)u=h.getUint32(p,!1),u=2147483647&u,d=h.getUint32(p+4,!1),p+=12,m.push({size:u,offset:a,duration:d,time:o,timescale:i}),a+=u,o+=d;if(p!==n)throw"Error: final pos "+p+" differs from SIDX end "+n;return m},a=function(e,t,n){var r,i,a,s,l,u,d;for(r=o.call(this,e,n),i=[],s=0,l=r.length;l>s;s+=1)a=new Dash.vo.Segment,a.duration=r[s].duration,a.media=t,a.startTime=r[s].time,a.timescale=r[s].timescale,u=r[s].offset,d=r[s].offset+r[s].size-1,a.mediaRange=u+"-"+d,i.push(a);return this.debug.log("Parsed SIDX box: "+i.length+" segments."),Q.when(i)},s=function(t){var n,o,a,l,u,d,c,f=Q.defer(),g=new DataView(t),h=0,p="",m=0,y=!1,v=this;for(v.debug.log("Searching for initialization.");"moov"!==p&&g.byteLength>h;){for(m=g.getUint32(h),h+=4,p="",u=0;4>u;u+=1)d=g.getInt8(h),p+=String.fromCharCode(d),h+=1;"moov"!==p&&(h+=m-8)}return l=g.byteLength-h,"moov"!==p?(v.debug.log("Loading more bytes to find initialization."),a.start=0,a.end=r+i,c=new XMLHttpRequest,c.onloadend=function(){y||f.reject("Error loading initialization.")},c.onload=function(){y=!0,r=a.end,s.call(v,c.response).then(function(e){f.resolve(e)})},c.onerror=function(){f.reject("Error loading initialization.")},c.responseType="arraybuffer",c.open("GET",e),c.setRequestHeader("Range","bytes="+a.start+"-"+a.end),c.send(null)):(n=h-8,o=n+m-1,a=n+"-"+o,v.debug.log("Found the initialization.  Range: "+a),f.resolve(a)),f.promise},l=function(n){var o=Q.defer(),a=new XMLHttpRequest,l=!1,u=this;return e=n,t={},u.debug.log("Start searching for initialization."),t.start=0,t.end=i,a.onloadend=function(){l||o.reject("Error finding initialization.")},a.onload=function(){l=!0,r=t.end,s.call(u,a.response).then(function(e){o.resolve(e)})},a.onerror=function(){o.reject("Error finding initialization.")},a.responseType="arraybuffer",a.open("GET",e),a.setRequestHeader("Range","bytes="+t.start+"-"+t.end),a.send(null),u.debug.log("Perform init search: "+e),o.promise},u=function(n,i){var o,a,s,l,d,c,f,g,h,p,m,y=Q.defer(),v=new DataView(n),b=new XMLHttpRequest,M=0,w="",S=0,P=[],R=!1,T=this;for(void 0===i&&(i=!0),T.debug.log("Searching for SIDX box."),T.debug.log(r+" bytes loaded.");"sidx"!==w&&v.byteLength>M;){for(S=v.getUint32(M),M+=4,w="",s=0;4>s;s+=1)l=v.getInt8(M),w+=String.fromCharCode(l),M+=1;"sidx"!==w&&(M+=S-8)}if(o=v.byteLength,"sidx"!==w)throw"Could not find SIDX box!";if(S>o)T.debug.log("Found SIDX but we don't have all of it."),t.start=0,t.end=r+(S-o),b.onloadend=function(){R||y.reject("Error loading sidx.")},b.onload=function(){R=!0,r=t.end,u.call(T,b.response,i).then(function(e){y.resolve(e)})},b.onerror=function(){y.reject("Error loading sidx.")},b.responseType="arraybuffer",b.open("GET",e),b.setRequestHeader("Range","bytes="+t.start+"-"+t.end),b.send(null);else if(t.start=M-8,t.end=t.start+S,T.debug.log("Found the SIDX box.  Start: "+t.start+" | End: "+t.end),a=n.slice(t.start,t.end),i){for(i=!1,d=this.parseSIDX.call(this,a,t.start),T.debug.log("Loading multi-level SIDX for Sony stream."),f=0,c=d.length;c>f;f+=1)g=d[f].offset,h=d[f].offset+d[f].size-1,p=g+"-"+h,P.push(this.loadSegments.call(T,e,p,i));Q.all(P).then(function(e){for(m=[],f=0,c=e.length;c>f;f+=1)m=m.concat(e[f]);i=!0,y.resolve(m)})}else this.parseSegments.call(T,a,e,t.start,!1).then(function(e){y.resolve(e)});return y.promise},d=function(o,s,l){var d,c=Q.defer(),f=new XMLHttpRequest,g=!1,h=this;return e=o,t={},null===s?(h.debug.log("No known range for SIDX request."),n=!0,t.start=0,t.end=i):(d=s.split("-"),t.start=parseFloat(d[0]),t.end=parseFloat(d[1])),f.onloadend=function(){g||c.reject("Error loading sidx.")},f.onload=function(){g=!0,n?(r=t.end,u.call(h,f.response,l).then(function(e){c.resolve(e)})):a.call(h,f.response,e,t.start).then(function(e){c.resolve(e)})},f.onerror=function(){c.reject("Error loading sidx.")},f.responseType="arraybuffer",f.open("GET",e),f.setRequestHeader("Range","bytes="+t.start+"-"+t.end),f.send(null),h.debug.log("Perform SIDX load: "+e),c.promise};return{debug:void 0,loadSegments:d,loadInitialization:l,parseSegments:a,parseSIDX:o,findSIDX:u}},Dash.dependencies.SonyExtensions.prototype={constructor:Dash.dependencies.SonyExtensions},Dash.vo.Segment=function(){"use strict";this.indexRange=null,this.index=null,this.mediaRange=null,this.media=null,this.duration=0/0,this.startTime=0/0,this.timescale=0/0},Dash.vo.Segment.prototype={constructor:Dash.vo.Segment},MediaPlayer.dependencies.AbrController=function(){"use strict";var e=!0,t={},n=function(e){var n;return t.hasOwnProperty(e)||(t[e]=0),n=t[e]},r=function(e,n){t[e]=n};return{debug:void 0,abrRulesCollection:void 0,manifestExt:void 0,metricsModel:void 0,getAutoSwitchBitrate:function(){return e},setAutoSwitchBitrate:function(t){e=t},getMetricsFor:function(e){var t=Q.defer(),n=this;return n.manifestExt.getIsVideo(e).then(function(r){r?t.resolve(n.metricsModel.getMetricsFor("video")):n.manifestExt.getIsAudio(e).then(function(e){e?t.resolve(n.metricsModel.getMetricsFor("audio")):t.resolve(n.metricsModel.getMetricsFor("stream"))})}),t.promise},getPlaybackQuality:function(t,i){var o,a,s,l,u,d=this,c=Q.defer(),f=999,g=[];return u=n(t),d.debug.log("ABR enabled? ("+e+")"),e?(d.debug.log("Check ABR rules."),d.getMetricsFor(i).then(function(e){d.abrRulesCollection.getRules().then(function(n){for(o=0,a=n.length;a>o;o+=1)g.push(n[o].checkIndex(u,e,i));Q.all(g).then(function(e){for(d.debug.log(e),l={},l[MediaPlayer.rules.SwitchRequest.prototype.STRONG]=999,l[MediaPlayer.rules.SwitchRequest.prototype.WEAK]=999,l[MediaPlayer.rules.SwitchRequest.prototype.DEFAULT]=999,o=0,a=e.length;a>o;o+=1)s=e[o],s.quality!==MediaPlayer.rules.SwitchRequest.prototype.NO_CHANGE&&(l[s.priority]=Math.min(l[s.priority],s.quality));999!==l[MediaPlayer.rules.SwitchRequest.prototype.WEAK]&&(f=l[MediaPlayer.rules.SwitchRequest.prototype.WEAK]),999!==l[MediaPlayer.rules.SwitchRequest.prototype.DEFAULT]&&(f=l[MediaPlayer.rules.SwitchRequest.prototype.DEFAULT]),999!==l[MediaPlayer.rules.SwitchRequest.prototype.STRONG]&&(f=l[MediaPlayer.rules.SwitchRequest.prototype.STRONG]),999!==f&&void 0!==f&&(u=f),d.manifestExt.getRepresentationCount(i).then(function(e){0>u&&(u=0),u>=e&&(u=e-1),r(t,u),d.debug.log("New quality of "+u),c.resolve(u)})})})})):(d.debug.log("Unchanged quality of "+u),c.resolve(u)),c.promise},setPlaybackQuality:function(e,t){var i=n(e);t!==i&&r(e,t)},getQualityFor:function(e){return n(e)}}},MediaPlayer.dependencies.AbrController.prototype={constructor:MediaPlayer.dependencies.AbrController},MediaPlayer.dependencies.BufferController=function(){"use strict";var e,t,n,r,i=1e3,o=.5,a="WAITING",s="READY",l="VALIDATING",u="LOADING",d=a,c=!1,f=!1,g=!0,h=!1,p=!1,m=-1,y=!1,v=!0,b=-1,M=null,w=null,S=!1,P=-1,R=null,T=!1,E=!1,x=null,D=null,L=!0,C=function(){if(-1!==m){var e,t,n=this.videoModel.getIsLive(),r=this.manifestModel.getValue();n&&null!==R&&void 0!==R&&null!==r&&void 0!==r&&(e=r.availabilityStartTime,t=(e.getTime()-R.getTime())/1e3,m-=t,E=!0)}},A=function(e,t){var n=0,r=null;L===!1&&(r=D.start,n=e.getTime()-r.getTime(),D.duration=n,D.stopreason=t,L=!0)},O=function(){var e,t=this,n=Q.defer(),r=t.videoModel.getIsLive(),i=0;return r&&(t.debug.log("Gathering information for live."),R=t.manifestModel.getValue().availabilityStartTime,null!==R&&void 0!==R&&(e=new Date,i=Math.floor((e.getTime()-R.getTime())/1e3)),C.call(t)),n.resolve(r),n.promise},B=function(e){var t=this;T&&E&&(t.videoModel.setCurrentTime(e),t.system.notify("setCurrentTime"),E=!1)},I=function(){if(c&&f){var e=this;O.call(this).then(function(t){T=t,e.debug.log("BufferController begin validation."),d=s,M=setInterval(w.bind(e),i,e)})}},q=function(){var t;null===M&&(h===!1&&(t=new Date,A(t,MediaPlayer.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),x=this.metricsModel.addPlayList(e,t,0,MediaPlayer.vo.metrics.PlayList.INITIAL_PLAY_START_REASON)),this.debug.log("BufferController start."),f=!0,I.call(this))},_=function(t){var n;this.debug.log("BufferController seek."),h=!0,m=t,-1!==P&&(m-=P),C.call(this),p=!0,n=new Date,A(n,MediaPlayer.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON),x=this.metricsModel.addPlayList(e,n,m,MediaPlayer.vo.metrics.PlayList.SEEK_START_REASON),q.call(this)},U=function(){this.debug.log("BufferController stop."),d=a,clearInterval(M),M=null,A(new Date,MediaPlayer.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON)},F=function(e,t){var n=null;return t&&t.Representation_asArray&&t.Representation_asArray.length>0&&(n=t.Representation_asArray[e]),n},N=function(){d===u&&(S&&(S=!1,this.videoModel.stallStream(e,S)),d=s)},H=function(t){var r=this,i=0;r.debug.log("Bytes finished loading."),r.fragmentController.process(t.data).then(function(t){if(null!==t){var o=F(b,r.getData()),s=r.videoModel.getCurrentTime(),l=new Date;r.debug.log("Push ("+e+") bytes: "+t.byteLength),L===!0&&d!==a&&-1!==b&&(L=!1,D=r.metricsModel.appendPlayListTrace(x,o.id,null,l,s,null,1,null)),r.sourceBufferExt.append(n,t,r.videoModel).then(function(){if(r.debug.log("Append complete: "+n.buffered.length),n.buffered.length>0){var e,t,o=n.buffered;for(r.debug.log("Number of buffered ranges: "+o.length),e=0,t=o.length;t>e;e+=1)r.debug.log("Buffered Range: "+o.start(e)+" - "+o.end(e));r.debug.log("Finished append, set seek? "+p),p&&(-1!==m&&(i=m),r.debug.log("Seeking to time: "+i),B.call(r,i),p=!1,m=-1),r.debug.log("Current time after append: "+r.videoModel.getCurrentTime())}N.call(r)})}else r.debug.log("No bytes to push."),N.call(r)})},k=function(){d===u&&(d=s),this.errHandler.downloadError("Error loading fragment.")},V=function(){U.call(this)},G=function(e,n){var r=null;return g&&(this.debug.log("Marking a special seek for initial playback."),h||(h=!0,m=0),g=!1),r=e||h?this.indexHandler.getInitRequest(n,t):Q.when(null)},z=function(e){var n;return v&&!h?(m=this.videoModel.getCurrentTime(),C.call(this),this.debug.log("Data changed - loading the fragment for time: "+m),n=this.indexHandler.getSegmentRequestForTime(m,e,t)):h?(this.debug.log("Loading the fragment for time: "+m),n=this.indexHandler.getSegmentRequestForTime(m,e,t),h=!1):(this.debug.log("Loading the next fragment."),n=this.indexHandler.getNextSegmentRequest(e,t)),v=!1,n},X=function(){var r,i,a=this,c=null,f=new Date,g=a.videoModel.getCurrentTime();i=h?m:g,a.sourceBufferExt.getBufferLength(n,i).then(function(n){if(a.debug.log("Current "+e+" buffer length: "+n),a.debug.log("Video time: "+g),d===u&&o>n){if(!S)return a.debug.log("Stalling Buffer: "+e),A(new Date,MediaPlayer.vo.metrics.PlayList.Trace.REBUFFERING_REASON),S=!0,a.videoModel.stallStream(e,S),Q.when(!1)}else d===s&&(d=l,a.metricsModel.addBufferLevel(e,new Date,n),a.bufferExt.shouldBufferMore(n).then(function(n){n?a.abrController.getPlaybackQuality(e,t).then(function(t){if(a.debug.log("Playback quality: "+t),a.debug.log("Populate buffers."),void 0!==t&&(r=t),y=t!==b,y===!0){if(c=F(r,a.getData()),null===c||void 0===c)throw"Unexpected error!";A(new Date,MediaPlayer.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON),a.metricsModel.addRepresentationSwitch(e,f,g,c.id)}return a.debug.log(y?"Quality changed to: "+t:"Quality didn't change."),G.call(a,y,t)}).then(function(e){return null!==e&&(a.debug.log("Loading initialization."),a.debug.log(e),a.fragmentLoader.load(e).then(H.bind(a),k.bind(a))),z.call(a,r)}).then(function(e){if(null!==e){switch(e.action){case"complete":a.debug.log("Stream is complete."),A(new Date,MediaPlayer.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON),V.call(a);break;case"download":a.debug.log("Loading a segment: "+e.url),d=u,a.fragmentLoader.load(e).then(H.bind(a),k.bind(a));break;default:a.debug.log("Unknown request action.")}e=null}b=r,d===l&&(d=s)}):d===l&&(d=s)}))})};return w=function(){X.call(this)},{videoModel:void 0,metricsModel:void 0,manifestExt:void 0,manifestModel:void 0,bufferExt:void 0,sourceBufferExt:void 0,fragmentController:void 0,abrController:void 0,fragmentExt:void 0,fragmentLoader:void 0,indexHandler:void 0,debug:void 0,system:void 0,errHandler:void 0,setup:function(){var t=this,n=t.videoModel.getIsLive();t.indexHandler.setIsLive(n),t.manifestExt.getDuration(t.manifestModel.getValue(),n).then(function(e){t.indexHandler.setDuration(e)}),t.indexHandler.setType(e),c=!0,I.call(this)},getType:function(){return e},setType:function(t){e=t,void 0!==this.indexHandler&&this.indexHandler.setType(t)},getAutoSwitchBitrate:function(){var e=this;return e.abrController.getAutoSwitchBitrate()},setAutoSwitchBitrate:function(e){var t=this;t.abrController.setAutoSwitchBitrate(e)},getData:function(){return t},setData:function(e){t=e,v=!0},getBuffer:function(){return n},setBuffer:function(e){n=e},getMinBufferTime:function(){return r},setMinBufferTime:function(e){r=e},clearMetrics:function(){var t=this;null!==e&&""!==e&&t.metricsModel.clearCurrentMetricsForType(e)},start:q,seek:_,stop:U}},MediaPlayer.dependencies.BufferController.prototype={constructor:MediaPlayer.dependencies.BufferController},MediaPlayer.dependencies.BufferControllerUpdater=function(){"use strict";var e,t="manifest",n="manifestUpdated",r=[],i=function(e,t){var n,r,i,o,a,s,l,u,d=e.getData(),c=0,f=0,g=0;if(d.hasOwnProperty("SegmentTemplate")&&(n=d.SegmentTemplate,n.hasOwnProperty("SegmentTimeline")&&(r=n.SegmentTimeline,r.hasOwnProperty("S")&&(i=r.S))),t.hasOwnProperty("SegmentTemplate")&&(o=t.SegmentTemplate,o.hasOwnProperty("SegmentTimeline")&&(a=o.SegmentTimeline,a.hasOwnProperty("S")&&(s=a.S))),null!==s&&null!==i){for(u=s[0],g=u.t;i.length>c&&s.length>0;)l=i[c],0===f&&(f=l.t),f===g&&(g+=u.d,s.shift(),u=s[0]),f+=l.d,c+=1;for(;s.length>0;)i.push(s.shift())}},o=function(t){var n,r,i=this;return"video"===t?r=i.manifestExt.getVideoData(e):"audio"===t?r=i.manifestExt.getAudioData(e):(n="Unknown buffer type: "+t,i.debug.log(n),r=Q.reject(n)),r},a=function(t,n){var r,a=this,s=Q.defer(),l=a.videoModel.getIsLive();return a.manifestExt.getDuration(e,l).then(function(){return a.debug.log("Gathering information for buffers. (2)"),a.bufferExt.decideBufferLength(e.minBufferTime)}).then(function(e){return a.debug.log("Gathering information for buffers. (3)"),a.debug.log("Buffer time: "+e),r=e,o.call(a,n)}).then(function(e){i.call(a,t,e)},function(e){a.debug.log("Recieved Error: "+e)}),s.promise},s=function(){var e,t,n=this,i=[];for(t=0;r.length>t;t+=1)e=r[t],i.push(a.call(n,e.bufferController,e.type));i.length>0&&Q.all(i)},l=function(e,t){var n={};n.bufferController=e,n.type=t,r.push(n)},u=function(e){var t,n;for(n=0;r.length>n;n+=1)if(t=r[n],e===t.bufferController)return r.splice(n,1),void 0},d=function(){var n=this;e=n.system.getObject(t),s.call(n)};return{debug:void 0,system:void 0,manifestExt:void 0,bufferExt:void 0,videoModel:void 0,setup:function(){var e=this;e.system.mapHandler(n,t,d.bind(e))},addBufferController:l,removeBufferController:u}},MediaPlayer.dependencies.BufferControllerUpdater.prototype={constructor:MediaPlayer.dependencies.BufferControllerUpdater},MediaPlayer.dependencies.BufferExtensions=function(){"use strict";var e;return{decideBufferLength:function(t){return e=4,e=isNaN(t)||0>=t?4:t,Q.when(e)},shouldBufferMore:function(t){var n=e>t;return Q.when(n)}}},MediaPlayer.dependencies.BufferExtensions.prototype={constructor:MediaPlayer.dependencies.BufferExtensions},MediaPlayer.utils.Capabilities=function(){"use strict"},MediaPlayer.utils.Capabilities.prototype={constructor:MediaPlayer.utils.Capabilities,supportsMediaSource:function(){"use strict";var e=null!==window.WebKitMediaSource&&void 0!==window.WebKitMediaSource,t=null!==window.MediaSource&&void 0!==window.MediaSource;return e||t},supportsCodec:function(e,t){"use strict";if(!(e instanceof HTMLVideoElement))throw"element must be of type HTMLVideoElement.";var n=e.canPlayType(t);return"probably"===n}},$.expr[":"].contains=$.expr.createPseudo(function(e){return function(t){return $(t).text().toUpperCase().indexOf(e.toUpperCase())>=0}}),MediaPlayer.utils.Debug=function(){"use strict";var e=null,t=!0,n="",r=function(){if(null!==e){var t,r=e.children();""===n||void 0===n||null===n?r.show():(t=r.filter(":contains("+n+")"),r.not(t).hide(),t.show())}},i=function(){var t=e.children()[0];""===n||void 0===n||null===n?$(t).show():-1===$(t).text().toUpperCase().indexOf(n.toUpperCase())&&$(t).hide()};return{init:function(t){e=$(t)},clear:function(){e.empty()},getFilter:function(){return n},setFilter:function(e){e!==n&&(n=e,r())},getLogToHtmlConsole:function(){return t},setLogToHtmlConsole:function(e){t=e},log:function(n){if(console.log(n),null!==e&&t){var r="<dt>"+n+"</dt>";e.prepend(r),i()}}}},MediaPlayer.dependencies.ErrorHandler=function(){"use strict";return{downloadError:function(e){var t="<span>File loading error.  This is most likely caused by the Cross Origin Resource Sharing (CORS) headers not being present in the response from the server which is hosting the file. Please check your server implementation to ensure that CORS headers are in place, as the JavaScript will not be able to request the manifest or segments without them.</span>",n="<div id='message' class='message' style='display: none'><p><span style='text-align: center; width: 100%; font-weight: bold;'>"+e+"</span><br/><br/>"+t+"</p><a href='#' class='close-notify'>X</a></div>";$("body").append(n),$("#message").fadeIn("slow"),$("#message a.close-notify").click(function(){return $("#message").fadeOut("slow"),!1})},mediaSourceError:function(e){var t="<span>MediaSource has encountered an error.</span>",n="<div id='message' class='message' style='display: none'><p><span style='text-align: center; width: 100%; font-weight: bold;'>"+e+"</span><br/><br/>"+t+"</p><a href='#' class='close-notify'>X</a></div>";$("body").append(n),$("#message").fadeIn("slow"),$("#message a.close-notify").click(function(){return $("#message").fadeOut("slow"),!1})}}},MediaPlayer.dependencies.ErrorHandler.prototype={constructor:MediaPlayer.dependencies.ErrorHandler},MediaPlayer.dependencies.FragmentController=function(){"use strict"},MediaPlayer.dependencies.FragmentController.prototype={constructor:MediaPlayer.dependencies.FragmentController,process:function(e){"use strict";var t=null;return null!==e&&void 0!==e&&e.byteLength>0&&(t=new Uint8Array(e)),Q.when(t)}},MediaPlayer.dependencies.FragmentLoader=function(){"use strict";var e=[],t=null,n=!1,r=function(){var i=new XMLHttpRequest,o=new MediaPlayer.vo.metrics.HTTPRequest,a=!1,s=this;e.length>0?(t=e.shift(),t.requestStartDate=new Date,n=!0,i.responseType="arraybuffer",i.open("GET",t.url,!0),t.range&&i.setRequestHeader("Range","bytes="+t.range),i.onloadend=function(){a||t.deferred.reject("Error loading fragment.")},i.onload=function(){a=!0;var e=new MediaPlayer.vo.metrics.HTTPRequest.Trace,n=new Date,l=i.response;e.s=n,t.requestEndDate=n,o=s.metricsModel.addHttpRequest(t.streamType,null,t.type,t.url,null,t.range,t.requestStartDate,t.requestEndDate,i.status,null,t.duration),s.metricsModel.appendHttpTrace(o,n,(new Date).getTime()-n.getTime(),[l.byteLength]),t.deferred.resolve({data:l,request:t}),t.deferred=null,t=null,i=null,r.call(s)},i.onerror=function(){o=s.metricsModel.addHttpRequest(t.streamType,null,t.type,t.url,null,t.range,t.requestStartDate,new Date,i.status,null,t.duration),t.deferred.reject("Error loading fragment.")},i.send()):n=!1},i=function(t){var i=Q.defer();return t.deferred=i,e.push(t),n||r.call(this),i.promise};return{metricsModel:void 0,getLoading:function(){return n},load:function(e){var t=null;if(e)return t=i.call(this,e)}}},MediaPlayer.dependencies.FragmentLoader.prototype={constructor:MediaPlayer.dependencies.FragmentLoader},MediaPlayer.dependencies.ManifestLoader=function(){"use strict";var e=function(e){var t=null;return-1!==e.indexOf("/")&&(t=e.substring(0,e.lastIndexOf("/")+1)),t},t=function(t){var n=e(t),r=Q.defer(),i=new XMLHttpRequest,o=new Date,a=!1,s=this;return this.debug.log("Start loading manifest: "+t),i.open("GET",t,!0),i.onloadend=function(){a||r.reject("Error loading manifest.")},i.onload=function(){a=!0,s.metricsModel.addHttpRequest("stream",null,"MPD",t,null,null,o,new Date,i.status,null,null),s.parser.parse(i.responseText,n).then(function(e){e.mpdUrl=t,r.resolve(e)})},i.onerror=function(){s.metricsModel.addHttpRequest("stream",null,"MPD",t,null,null,o,new Date,i.status,null,null),r.reject("Error loading manifest.")},i.send(),r.promise};return{debug:void 0,parser:void 0,metricsModel:void 0,load:t}},MediaPlayer.dependencies.ManifestLoader.prototype={constructor:MediaPlayer.dependencies.ManifestLoader},MediaPlayer.models.ManifestModel=function(){"use strict";var e;return{getValue:function(){return e},setValue:function(t){e=t}}},MediaPlayer.models.ManifestModel.prototype={constructor:MediaPlayer.models.ManifestModel},MediaPlayer.dependencies.ManifestUpdater=function(){"use strict";var e=0/0,t=null,n=null,r=function(){null!==t&&(clearInterval(t),t=null)},i=function(){r.call(this),isNaN(e)||(this.debug.log("Refresh manifest in "+e+" seconds."),t=setInterval(n.bind(this),1e3*e,this))},o=function(){var t=this,n=t.manifestModel.getValue();void 0!==n&&null!==n&&t.manifestExt.getRefreshDelay(n).then(function(n){e=n,i.call(t)})};return n=function(){var e=this,t=e.manifestModel.getValue();e.debug.log("Refresh manifest."),e.manifestLoader.load(t.mpdUrl).then(function(t){e.debug.log("Manifest has been updated."),e.manifestModel.setValue(t),e.debug.log("Manifest has been refreshed."),o.call(e),e.system.notify("manifestUpdated")})},{debug:void 0,system:void 0,manifestModel:void 0,manifestExt:void 0,manifestLoader:void 0,setup:function(){o.call(this)},init:function(){o.call(this)}}},MediaPlayer.dependencies.ManifestUpdater.prototype={constructor:MediaPlayer.dependencies.ManifestUpdater},MediaPlayer.dependencies.MediaSourceExtensions=function(){"use strict"},MediaPlayer.dependencies.MediaSourceExtensions.prototype={constructor:MediaPlayer.dependencies.MediaSourceExtensions,createMediaSource:function(){"use strict";var e=null!==window.WebKitMediaSource,t=null!==window.MediaSource;return e?Q.when(new WebKitMediaSource):t?Q.when(new MediaSource):null},attachMediaSource:function(e,t){"use strict";return t.setSource(window.URL.createObjectURL(e)),Q.when(!0)},setDuration:function(e,t){"use strict";return e.duration=t,Q.when(e.duration)}},MediaPlayer.models.MetricsModel=function(){"use strict";return{system:void 0,streamMetrics:{},clearCurrentMetricsForType:function(e){delete this.streamMetrics[e]},clearAllCurrentMetrics:function(){this.streamMetrics={}},getReadOnlyMetricsFor:function(e){return this.streamMetrics.hasOwnProperty(e)?this.streamMetrics[e]:null},getMetricsFor:function(e){var t;return this.streamMetrics.hasOwnProperty(e)?t=this.streamMetrics[e]:(t=this.system.getObject("metrics"),this.streamMetrics[e]=t),t},addTcpConnection:function(e,t,n,r,i,o){var a=new MediaPlayer.vo.metrics.TCPConnection;return a.tcpid=t,a.dest=n,a.topen=r,a.tclose=i,a.tconnect=o,this.getMetricsFor(e).TcpList.push(a),a},addHttpRequest:function(e,t,n,r,i,o,a,s,l,u,d){var c=new MediaPlayer.vo.metrics.HTTPRequest;return c.tcpid=t,c.type=n,c.url=r,c.actualurl=i,c.range=o,c.trequest=a,c.tresponse=s,c.responsecode=l,c.interval=u,c.mediaduration=d,this.getMetricsFor(e).HttpList.push(c),c},appendHttpTrace:function(e,t,n,r){var i=new MediaPlayer.vo.metrics.HTTPRequest.Trace;return i.s=t,i.d=n,i.b=r,e.trace.push(i),i},addRepresentationSwitch:function(e,t,n,r,i){var o=new MediaPlayer.vo.metrics.RepresentationSwitch;return o.t=t,o.mt=n,o.to=r,o.lto=i,this.getMetricsFor(e).RepSwitchList.push(o),o},addBufferLevel:function(e,t,n){var r=new MediaPlayer.vo.metrics.BufferLevel;return r.t=t,r.level=n,this.getMetricsFor(e).BufferLevel.push(r),r},addPlayList:function(e,t,n,r){var i=new MediaPlayer.vo.metrics.PlayList;return i.start=t,i.mstart=n,i.starttype=r,this.getMetricsFor(e).PlayList.push(i),i},appendPlayListTrace:function(e,t,n,r,i,o,a,s){var l=new MediaPlayer.vo.metrics.PlayList.Trace;return l.representationid=t,l.subreplevel=n,l.start=r,l.mstart=i,l.duration=o,l.playbackspeed=a,l.stopreason=s,e.trace.push(l),l}}},MediaPlayer.models.MetricsModel.prototype={constructor:MediaPlayer.models.MetricsModel},MediaPlayer.dependencies.SourceBufferExtensions=function(){"use strict"},MediaPlayer.dependencies.SourceBufferExtensions.prototype={constructor:MediaPlayer.dependencies.SourceBufferExtensions,createSourceBuffer:function(e,t){"use strict";return Q.when(e.addSourceBuffer(t))},removeSourceBuffer:function(e,t){"use strict";return Q.when(e.removeSourceBuffer(t))},getBufferLength:function(e,t){"use strict";var n,r,i=null,o=-1,a=0;if(i=e.buffered,null!==i)for(r=0,n=i.length;n>r;r+=1)t>=i.start(r)&&i.end(r)>t&&(o=r);return-1!==o&&(a=i.end(o)-t),function(){return Q.when(a)}()},append:function(e,t){"use strict";try{return e.append(t),Q.when(!0)}catch(n){return Q.when(!1)}},abort:function(e){"use strict";return Q.when(e.abort())}},MediaPlayer.dependencies.Stream=function(){"use strict";var e,t,n,r=null,i=-1,o=null,a=-1,s=!0,l=!1,u=!1,d=!1,c=!1,f=function(){this.debug.log("Attempting play..."),l&&(this.debug.log("Do play."),this.videoModel.play())},g=function(){this.debug.log("Do pause."),this.videoModel.pause()},h=function(e){this.debug.log("Attempting seek..."),l&&(this.debug.log("Do seek: "+e),r&&r.seek(e),o&&o.seek(e))},p=function(){var e=Q.defer(),n=this,r=function(e){var t=n.videoModel.getElement().error,r=null!==t&&void 0!==t?t.code:-1,i="";if(-1!==r){switch(r){case 1:i="MEDIA_ERR_ABORTED";break;case 2:i="MEDIA_ERR_NETWORK";break;case 3:i="MEDIA_ERR_DECODE";break;case 4:i="MEDIA_ERR_SRC_NOT_SUPPORTED";break;case 5:i="MEDIA_ERR_ENCRYPTED"}c=!0,g.call(n),n.debug.log("MediaSource Close."),n.debug.log(e),n.debug.log("Video Element Error:"),n.debug.log(n.videoModel.getElement().error),n.errHandler.mediaSourceError(i)}},i=function(r){n.debug.log("MediaSource is open!"),n.debug.log(r),t.removeEventListener("sourceopen",i),t.removeEventListener("webkitsourceopen",i),e.resolve(t)};return this.debug.log("MediaSource should be closed. ("+t.readyState+")"),t.addEventListener("sourceclose",r,!1),t.addEventListener("webkitsourceclose",r,!1),t.addEventListener("sourceopen",i,!1),t.addEventListener("webkitsourceopen",i,!1),this.mediaSourceExt.attachMediaSource(t,this.videoModel),this.debug.log("MediaSource attached to video.  Waiting on open..."),e.promise},m=function(){r.clearMetrics(),o.clearMetrics()},y=function(){var e,n,i=this;r.stop(),o.stop(),m.call(this),c||(e=r.getBuffer(),i.sourceBufferExt.abort(e),i.sourceBufferExt.removeSourceBuffer(t,e),n=o.getBuffer(),i.sourceBufferExt.abort(n),i.sourceBufferExt.removeSourceBuffer(t,n)),r=null,o=null,i.videoModel.setSource(null)},v=function(e,t,n){if(e&&t)if(null===r&&null===o){var i="No streams to play.";alert(i),this.debug.log(i),n.reject(i)}else this.debug.log("MediaSource initialized!"),n.resolve(!0)},b=function(){this.debug.log("Getting MediaSource ready...");var e,n=Q.defer(),s=!1,l=!1,u=this,d=u.manifestModel.getValue(),c=u.videoModel.getIsLive();return u.debug.log("Gathering information for buffers. (1)"),u.manifestExt.getDuration(d,c).then(function(){u.debug.log("Gathering information for buffers. (2)"),u.bufferExt.decideBufferLength(d.minBufferTime).then(function(t){return u.debug.log("Gathering information for buffers. (3)"),u.debug.log("Buffer time: "+t),e=t,u.manifestExt.getVideoData(d)}).then(function(o){return null!==o?(u.debug.log("Create video buffer."),u.manifestExt.getDataIndex(o,d).then(function(e){i=e,u.debug.log("Save video track: "+i)}),u.manifestExt.getCodec(o).then(function(e){var n;return u.debug.log("Video codec: "+e),u.capabilities.supportsCodec(u.videoModel.getElement(),e)?n=u.sourceBufferExt.createSourceBuffer(t,e):(u.debug.log("Codec ("+e+") is not supported."),alert("Codec ("+e+") is not supported."),n=Q.when(null)),n}).then(function(t){null===t?u.debug.log("No buffer was created, skipping video stream."):(r=u.system.getObject("bufferController"),r.setType("video"),r.setData(o),r.setBuffer(t),r.setMinBufferTime(e),u.debug.log("Video is ready!")),s=!0,v.call(u,s,l,n)},function(){alert("Error creating source buffer."),s=!0,v.call(u,s,l,n)})):(u.debug.log("No video data."),s=!0,v.call(u,s,l,n)),u.manifestExt.getAudioDatas(d)}).then(function(r){null!==r&&r.length>0?(u.debug.log("Have audio streams: "+r.length),u.manifestExt.getPrimaryAudioData(d).then(function(r){u.manifestExt.getDataIndex(r,d).then(function(e){a=e,u.debug.log("Save audio track: "+a)}),u.manifestExt.getCodec(r).then(function(e){var n;return u.debug.log("Audio codec: "+e),u.capabilities.supportsCodec(u.videoModel.getElement(),e)?n=u.sourceBufferExt.createSourceBuffer(t,e):(u.debug.log("Codec ("+e+") is not supported."),alert("Codec ("+e+") is not supported."),n=Q.when(null)),n}).then(function(t){null===t?u.debug.log("No buffer was created, skipping audio stream."):(o=u.system.getObject("bufferController"),o.setType("audio"),o.setData(r),o.setBuffer(t),o.setMinBufferTime(e),u.debug.log("Audio is ready!")),l=!0,v.call(u,s,l,n)},function(){alert("Error creating source buffer."),l=!0,v.call(u,s,l,n)})})):(u.debug.log("No audio streams."),l=!0,v.call(u,s,l,n))})}),n.promise},M=function(){var e=this,n=Q.defer(),r=e.videoModel.getIsLive();return e.debug.log("Getting ready for playback..."),e.manifestExt.getDuration(e.manifestModel.getValue(),r).then(function(n){return e.debug.log("Setting duration: "+n),e.mediaSourceExt.setDuration(t,n)}).then(function(){e.debug.log("Duration successfully set."),l=!0,n.resolve(!0)}),n.promise},w=function(){this.debug.log("Got play event."),l&&(this.debug.log("Starting playback."),r&&r.start(),o&&o.start())},S=function(){this.debug.log("Got pause event."),r&&r.stop(),o&&o.stop()},P=function(){this.debug.log("Got seeking event."),r&&r.seek(this.videoModel.getCurrentTime()),o&&o.seek(this.videoModel.getCurrentTime())},R=function(){},T=function(){if(u&&d){var r=this,i=n,o=r.videoModel.getIsLive();r.debug.log("Stream start loading."),r.manifestLoader.load(i).then(function(t){return e=t,r.manifestModel.setValue(e),r.debug.log("Manifest has loaded."),r.debug.log(r.manifestModel.getValue()),r.manifestUpdater.init(),r.mediaSourceExt.createMediaSource()}).then(function(e){return t=e,r.debug.log("MediaSource created."),p.call(r)}).then(function(){return r.debug.log("MediaSource set up."),b.call(r)}).then(function(){return r.debug.log("Start initializing playback."),M.call(r)}).then(function(){r.debug.log("Playback initialized!"),o?r.manifestExt.getLiveEdge(r.manifestModel.getValue()).then(function(e){r.debug.log("Got live content.  Starting playback at offset: "+e),h.call(r,e)}):(r.debug.log("Got VOD content.  Starting playback."),f.call(r))})}},E=function(){var e,t,n=this,s=n.manifestModel.getValue();n.debug.log("Manifest updated... set new data on buffers."),r&&(e=r.getData(),e.hasOwnProperty("id")?n.manifestExt.getDataForId(e.id,s).then(function(e){r.setData(e)}):n.manifestExt.getDataForIndex(i,s).then(function(e){r.setData(e)})),o&&(t=o.getData(),t.hasOwnProperty("id")?n.manifestExt.getDataForId(t.id,s).then(function(e){o.setData(e)}):n.manifestExt.getDataForIndex(a,s).then(function(e){o.setData(e)}))};return{system:void 0,videoModel:void 0,manifestLoader:void 0,manifestUpdater:void 0,manifestModel:void 0,mediaSourceExt:void 0,sourceBufferExt:void 0,bufferExt:void 0,manifestExt:void 0,fragmentController:void 0,abrController:void 0,fragmentExt:void 0,capabilities:void 0,debug:void 0,metricsExt:void 0,bufferControllerUpdater:void 0,errHandler:void 0,setup:function(){this.videoModel.listen("play",w.bind(this)),this.videoModel.listen("pause",S.bind(this)),this.videoModel.listen("seeking",P.bind(this)),this.videoModel.listen("timeupdate",R.bind(this)),u=!0,T.call(this)
},getManifestExt:function(){var e=this;return e.manifestExt},setAutoPlay:function(e){s=e},getAutoPlay:function(){return s},load:function(e){n=e,d=!0,T.call(this)},manifestHasUpdated:E,reset:function(){g.call(this),y.call(this)},play:f,seek:h,pause:g}},MediaPlayer.dependencies.Stream.prototype={constructor:MediaPlayer.dependencies.Stream},MediaPlayer.models.VideoModel=function(){"use strict";var e,t=!1,n=[],r=0,i=function(){return n.length>0},o=function(t){null!==t&&n[t]!==!0&&(n.push(t),n[t]=!0,e.playbackRate=0)},a=function(t){if(null!==t){n[t]=!1;var r=n.indexOf(t);-1!==r&&n.splice(r,1),i()===!1&&(e.playbackRate=1)}},s=function(e,t){t?o(e):a(e)},l=function(){e.currentTime!==r&&(e.currentTime=r)};return{system:void 0,setup:function(){this.system.mapHandler("setCurrentTime",void 0,l.bind(this))},play:function(){e.play()},pause:function(){e.pause()},isPaused:function(){return e.paused},getPlaybackRate:function(){return e.playbackRate},setPlaybackRate:function(t){e.playbackRate=t},getCurrentTime:function(){return e.currentTime},setCurrentTime:function(e){r=e},listen:function(t,n){e.addEventListener(t,n,!1)},getElement:function(){return e},setElement:function(t){e=t},setSource:function(t){e.src=t},getIsLive:function(){return t},setIsLive:function(e){t=e},stallStream:s,isStalled:i}},MediaPlayer.models.VideoModel.prototype={constructor:MediaPlayer.models.VideoModel},MediaPlayer.dependencies.VideoModelExtensions=function(){"use strict";return{getDroppedFrames:function(e){var t=null!==e.webkitDroppedFrameCount,n=-1;return t&&(n=e.webkitDroppedFrameCount),n}}},MediaPlayer.dependencies.VideoModelExtensions.prototype={constructor:MediaPlayer.dependencies.VideoModelExtensions},MediaPlayer.rules.BaseRulesCollection=function(){"use strict";var e=[];return{downloadRatioRule:void 0,insufficientBufferRule:void 0,getRules:function(){return Q.when(e)},setup:function(){var e=this;e.getRules().then(function(t){t.push(e.downloadRatioRule),t.push(e.insufficientBufferRule)})}}},MediaPlayer.rules.BaseRulesCollection.prototype={constructor:MediaPlayer.rules.BaseRulesCollection},MediaPlayer.rules.DownloadRatioRule=function(){"use strict";var e=function(e,t){var n=this,r=Q.defer();return n.manifestExt.getBandwidth(e).then(function(e){n.manifestExt.getBandwidth(t).then(function(t){r.resolve(e/t)})}),r.promise};return{debug:void 0,manifestExt:void 0,checkIndex:function(t,n,r){var i,o,a,s,l,u,d,c,f=this,g=n.HttpList;return f.debug.log("Checking download ratio rule..."),n?null===g||void 0===g||0===g.length?(f.debug.log("No requests made for this stream yet, bailing."),Q.when(new MediaPlayer.rules.SwitchRequest)):(i=g[g.length-1],o=(i.tresponse.getTime()-i.trequest.getTime())/1e3,0>=o?(f.debug.log("Don't know how long the download of the last fragment took, bailing."),Q.when(new MediaPlayer.rules.SwitchRequest)):null===i.mediaduration||void 0===i.mediaduration||0>=i.mediaduration?(f.debug.log("Don't know the duration of the last media fragment, bailing."),Q.when(new MediaPlayer.rules.SwitchRequest)):(l=Q.defer(),a=i.mediaduration/o,f.debug.log("Download ratio: "+a),isNaN(a)?(f.debug.log("Invalid ratio, bailing."),l.resolve(new MediaPlayer.rules.SwitchRequest)):1>a?(f.debug.log("Download ratio is poor."),t>0?(f.debug.log("We are not at the lowest bitrate, so switch down."),f.manifestExt.getRepresentationFor(t-1,r).then(function(e){f.manifestExt.getBandwidth(e).then(function(e){f.manifestExt.getRepresentationFor(t,r).then(function(n){f.manifestExt.getBandwidth(n).then(function(n){s=e/n,f.debug.log("Switch ratio: "+s),s>a?(f.debug.log("Things must be going pretty bad, switch all the way down."),l.resolve(new MediaPlayer.rules.SwitchRequest(0))):(f.debug.log("Things could be better, so just switch down one index."),l.resolve(new MediaPlayer.rules.SwitchRequest(t-1)))})})})})):l.resolve(new MediaPlayer.rules.SwitchRequest(t))):(f.debug.log("Download ratio is good."),f.manifestExt.getRepresentationCount(r).then(function(n){n-=1,n>t?(f.debug.log("We are not at the highest bitrate, so switch up."),f.manifestExt.getRepresentationFor(t+1,r).then(function(i){f.manifestExt.getBandwidth(i).then(function(i){f.manifestExt.getRepresentationFor(t,r).then(function(r){f.manifestExt.getBandwidth(r).then(function(r){if(s=i/r,f.debug.log("Switch ratio: "+s),a>=s)if(a>1e3)f.debug.log("Tons of bandwidth available, go all the way up."),l.resolve(new MediaPlayer.rules.SwitchRequest(n-1));else if(a>100)f.debug.log("Just enough bandwidth available, switch up one."),l.resolve(new MediaPlayer.rules.SwitchRequest(t+1));else{for(f.debug.log("Not exactly sure where to go, so do some math."),d=-1,u=[];n>(d+=1);)u.push(e.call(f,d,t));Q.all(u).then(function(e){for(d=0,c=e.length;c>d&&!(e[d]>a);d+=1);f.debug.log("Calculated ideal new quality index is: "+d),l.resolve(new MediaPlayer.rules.SwitchRequest(d))})}else f.debug.log("Not enough bandwidth to switch up."),l.resolve(new MediaPlayer.rules.SwitchRequest)})})})})):l.resolve(new MediaPlayer.rules.SwitchRequest(n))})),l.promise)):(f.debug.log("No metrics, bailing."),Q.when(new MediaPlayer.rules.SwitchRequest))}}},MediaPlayer.rules.DownloadRatioRule.prototype={constructor:MediaPlayer.rules.DownloadRatioRule},MediaPlayer.rules.InsufficientBufferRule=function(){"use strict";var e=0,t=3;return{debug:void 0,checkIndex:function(n,r){var i,o,a=this,s=!1,l=MediaPlayer.rules.SwitchRequest.prototype.DEFAULT;return a.debug.log("Checking insufficient buffer rule..."),null===r.PlayList||void 0===r.PlayList||0===r.PlayList.length?(a.debug.log("Not enough information for rule."),Q.when(new MediaPlayer.rules.SwitchRequest)):(i=r.PlayList[r.PlayList.length-1],null===i||void 0===i||0===i.trace.length?(a.debug.log("Not enough information for rule."),Q.when(new MediaPlayer.rules.SwitchRequest)):(o=i.trace[i.trace.length-2],null===o||void 0===o||null===o.stopreason||void 0===o.stopreason?(a.debug.log("Not enough information for rule."),Q.when(new MediaPlayer.rules.SwitchRequest)):(o.stopreason===MediaPlayer.vo.metrics.PlayList.Trace.REBUFFERING_REASON&&(s=!0,e+=1,a.debug.log("Number of times the buffer has run dry: "+e)),e>t&&(l=MediaPlayer.rules.SwitchRequest.prototype.STRONG,a.debug.log("Apply STRONG to buffer rule.")),s?(a.debug.log("The buffer ran dry recently, switch down."),Q.when(new MediaPlayer.rules.SwitchRequest(n-1,l))):e>t?(a.debug.log("Too many dry buffer hits, quit switching bitrates."),Q.when(new MediaPlayer.rules.SwitchRequest(n,l))):Q.when(new MediaPlayer.rules.SwitchRequest(MediaPlayer.rules.SwitchRequest.prototype.NO_CHANGE,l)))))}}},MediaPlayer.rules.InsufficientBufferRule.prototype={constructor:MediaPlayer.rules.InsufficientBufferRule},MediaPlayer.rules.LimitSwitchesRule=function(){"use strict";var e=10,t=2e4,n=5,r=0;return{debug:void 0,checkIndex:function(i,o){if(r>0)return r-=1,Q.when(new MediaPlayer.rules.SwitchRequest(i,MediaPlayer.rules.SwitchRequest.prototype.STRONG));var a,s,l,u=this,d=!1,c=(new Date).getTime(),f=o.RepSwitchList.length;for(u.debug.log("Checking limit switches rule..."),l=f-1;l>=0;l-=1){if(a=o.RepSwitchList[l],s=c-a.t.getTime(),s>=t){u.debug.log("Reached time limit, bailing.");break}if(l>=e){u.debug.log("Found too many switches within validation time, force the stream to not change."),d=!0;break}}return d?(u.debug.log("Wait some time before allowing another switch."),r=n,Q.when(new MediaPlayer.rules.SwitchRequest(i,MediaPlayer.rules.SwitchRequest.prototype.STRONG))):Q.when(new MediaPlayer.rules.SwitchRequest(MediaPlayer.rules.SwitchRequest.prototype.NO_CHANGE,MediaPlayer.rules.SwitchRequest.prototype.STRONG))}}},MediaPlayer.rules.LimitSwitchesRule.prototype={constructor:MediaPlayer.rules.LimitSwitchesRule},MediaPlayer.rules.SwitchRequest=function(e,t){"use strict";this.quality=e,this.priority=t,void 0===this.quality&&(this.quality=999),void 0===this.priority&&(this.priority=.5)},MediaPlayer.rules.SwitchRequest.prototype={constructor:MediaPlayer.rules.SwitchRequest,NO_CHANGE:999,DEFAULT:.5,STRONG:1,WEAK:0},MediaPlayer.models.MetricsList=function(){"use strict";return{TcpList:[],HttpList:[],RepSwitchList:[],BufferLevel:[],PlayList:[],DroppedFrames:[]}},MediaPlayer.models.MetricsList.prototype={constructor:MediaPlayer.models.MetricsList},MediaPlayer.vo.SegmentRequest=function(){"use strict";this.action="download",this.startTime=0/0,this.streamType=null,this.type=null,this.duration=0/0,this.timescale=0/0,this.range=null,this.url=null,this.requestStartDate=null,this.requestEndDate=null,this.deferred=null},MediaPlayer.vo.SegmentRequest.prototype={constructor:MediaPlayer.vo.SegmentRequest,ACTION_DOWNLOAD:"download",ACTION_COMPLETE:"complete"},MediaPlayer.vo.metrics.BufferLevel=function(){"use strict";this.t=null,this.level=null},MediaPlayer.vo.metrics.BufferLevel.prototype={constructor:MediaPlayer.vo.metrics.BufferLevel},MediaPlayer.vo.metrics.DroppedFrames=function(){"use strict";this.time=null,this.droppedFrames=null},MediaPlayer.vo.metrics.DroppedFrames.prototype={constructor:MediaPlayer.vo.metrics.DroppedFrames},MediaPlayer.vo.metrics.HTTPRequest=function(){"use strict";this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.responsecode=null,this.interval=null,this.mediaduration=null,this.trace=[]},MediaPlayer.vo.metrics.HTTPRequest.prototype={constructor:MediaPlayer.vo.metrics.HTTPRequest},MediaPlayer.vo.metrics.HTTPRequest.Trace=function(){"use strict";this.s=null,this.d=null,this.b=[]},MediaPlayer.vo.metrics.HTTPRequest.Trace.prototype={constructor:MediaPlayer.vo.metrics.HTTPRequest.Trace},MediaPlayer.vo.metrics.PlayList=function(){"use strict";this.start=null,this.mstart=null,this.starttype=null,this.trace=[]},MediaPlayer.vo.metrics.PlayList.Trace=function(){"use strict";this.representationid=null,this.subreplevel=null,this.start=null,this.mstart=null,this.duration=null,this.playbackspeed=null,this.stopreason=null},MediaPlayer.vo.metrics.PlayList.prototype={constructor:MediaPlayer.vo.metrics.PlayList},MediaPlayer.vo.metrics.PlayList.INITIAL_PLAY_START_REASON="initial_start",MediaPlayer.vo.metrics.PlayList.SEEK_START_REASON="seek",MediaPlayer.vo.metrics.PlayList.Trace.prototype={constructor:MediaPlayer.vo.metrics.PlayList.Trace()},MediaPlayer.vo.metrics.PlayList.Trace.USER_REQUEST_STOP_REASON="user_request",MediaPlayer.vo.metrics.PlayList.Trace.REPRESENTATION_SWITCH_STOP_REASON="representation_switch",MediaPlayer.vo.metrics.PlayList.Trace.END_OF_CONTENT_STOP_REASON="end_of_content",MediaPlayer.vo.metrics.PlayList.Trace.REBUFFERING_REASON="rebuffering",MediaPlayer.vo.metrics.RepresentationSwitch=function(){"use strict";this.t=null,this.mt=null,this.to=null,this.lto=null},MediaPlayer.vo.metrics.RepresentationSwitch.prototype={constructor:MediaPlayer.vo.metrics.RepresentationSwitch},MediaPlayer.vo.metrics.TCPConnection=function(){"use strict";this.tcpid=null,this.dest=null,this.topen=null,this.tclose=null,this.tconnect=null},MediaPlayer.vo.metrics.TCPConnection.prototype={constructor:MediaPlayer.vo.metrics.TCPConnection};